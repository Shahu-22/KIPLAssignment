@inject HttpClient Http
@inject NavigationManager Navigation

@if (IsVisible)
{
    <div class="modal-backdrop"></div>

    <div class="modal-container">
        <div class="modal-card">
            <div class="modal-header">
                <h4>Upload Matrix File</h4>
                <button class="close-btn" @onclick="Close">✕</button>
            </div>

            <div class="modal-body">
                <InputFile OnChange="OnFileSelected" />

                <label>
                    <input type="checkbox" @bind="replace" />
                    Replace existing file
                </label>

                <button class="btn btn-primary"
                        disabled="@isUploading"
                        @onclick="Upload">
                    @(isUploading ? "Uploading..." : "Upload")
                </button>

                <p class="status-text">@message</p>
            </div>
        </div>
    </div>
}
<style>
    /* Background overlay */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
    }

    /* Center container */
    .modal-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1001;
    }

    /* Modal box */
    .modal-card {
        width: 400px;
        background: white;
        border: 1px solid #ccc;
        border-radius: 6px;
        padding: 16px;
    }

    /* Header */
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
    }

    /* Close button */
    .close-btn {
        background: none;
        border: none;
        font-size: 18px;
        cursor: pointer;
    }

    /* Body */
    .modal-body {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* Status text */
    .status-text {
        font-size: 14px;
        color: #333;
    }
</style>

@code {
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnUploadCompleted { get; set; }

    private IBrowserFile? selectedFile;
    private bool replace = true;
    private bool isUploading = false;
    private string message = "";

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        message = "";
    }

    private async Task Upload()
    {
        if (selectedFile == null)
        {
            message = "Please select a file.";
            return;
        }

        isUploading = true;

        try
        {
            using var content = new MultipartFormDataContent();
            using var fileStream = selectedFile.OpenReadStream(10 * 1024 * 1024);

            content.Add(
                new StreamContent(fileStream),
                "file",
                selectedFile.Name
            );

          var url = $"{Navigation.BaseUri}api/upload?replace={replace}";
var response = await Http.PostAsync(url, content);


            if (response.IsSuccessStatusCode)
            {
                message = "Upload successful.";
                await OnUploadCompleted.InvokeAsync();
            }
            else
            {
                message = await response.Content.ReadAsStringAsync();
            }
        }
        catch (Exception ex)
        {
            message = ex.Message;
        }
        finally
        {
            isUploading = false;
        }
    }

    private async Task Close()
    {
        await OnClose.InvokeAsync();
    }
}
