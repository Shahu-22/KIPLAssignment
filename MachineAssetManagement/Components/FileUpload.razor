@page "/upload"
@rendermode InteractiveServer
@using MachineAssetManagement.Services
@using Microsoft.AspNetCore.Components.Forms
@inject UploadService UploadService

<h3>Upload Matrix File</h3>

<InputFile OnChange="OnFileSelected" />
<br />
<br />

<label>
    <input type="checkbox" @bind="replace" /> Replace existing matrix
</label>

<button class="btn btn-primary" @onclick="Upload" disabled="@isUploading">
    @(isUploading ? "Uploading..." : "Upload")
</button>

<p>@message</p>

@code {
    private IBrowserFile? selectedFile;
    private bool replace = true;
    private bool isUploading = false;
    private string message = "";

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        message = "";
    }

    private async Task Upload()
    {
        if (selectedFile == null)
        {
            message = "Please select a file.";
            return;
        }

        isUploading = true;
        try
        {
            // Save uploaded file temporarily
            var tempPath = Path.Combine(
                Path.GetTempPath(),
                Guid.NewGuid() + Path.GetExtension(selectedFile.Name)
            );

            await using (var fs = File.Create(tempPath))
            {
                await selectedFile.OpenReadStream(10 * 1024 * 1024).CopyToAsync(fs);
            }

            // Call UploadService (all logic is inside service)
            UploadService.SaveMatrix(tempPath, replace);

            message = "Upload successful!";
            File.Delete(tempPath); // cleanup
        }
        catch (Exception ex)
        {
            message = $"Upload failed: {ex.Message}";
        }
        finally
        {
            isUploading = false;
        }
    }
}
